var mapwrap=$("#amap_wrap"),contain=$("#map"),turn=10,zoomMin=7,zoomMax=12,filterData=[],slide,hotspotCity,map=new AMap.Map("map",{resizeEnable:!0,mapStyle:"amap://styles/3002bc552c47784f682fa3a1d6f9f319",features:["bg","road","point"],zoom:zoomMin,zooms:[zoomMin,16],center:[114.082038,22.55944],lang:"zh_cn"});function anchorHotspot(){$("html, body").animate({scrollTop:$("#hotspot").offset().top-($("header").height()+20)},500)}$.getJSON("./data/hotspot.json",(function(data){MTR.articleDetail=data,hotspotMarkers(),map.clearMap(),districtMarkers(MTR.articleDetail,"district"),sessionStorage.setItem("MODE","district")})).done((function(){return QueryString.hotspot?($.each(MTR.articleDetail,(function(i,region){$.each(region.City,(function(d,city){$.each(city.Hotspot,(function(c,spot){spot.HotspotId==QueryString.hotspot&&(showHotspot([region.RegionId,city.CityId,spot.HotspotLngLat,map.getZoom()]),showHotspotList(city.CityId),setTimeout((function(){openInfo(spot.HotspotId),QueryString.detail&&setTimeout((function(){openPopup([city.CityId,spot.HotspotId])}),1e3)}),1e3))}))}))})),void setTimeout((function(){anchorHotspot()}),1e3)):QueryString.city?($.each(MTR.articleDetail,(function(i,region){$.each(region.City,(function(d,city){city.CityId==QueryString.city&&(showHotspot([region.RegionId,city.CityId,city.CityLngLat,map.getZoom()]),showHotspotList(city.CityId),paramUpdate.update("city",city.CityId,city.CityName))}))})),void setTimeout((function(){anchorHotspot()}),1e3)):(QueryString.region&&($.each(MTR.articleDetail,(function(i,region){if(region.RegionId==QueryString.region)return setTimeout((function(){MTR.dropSelected=1,MTR.selected=region.RegionName}),1e3),$("#map").attr("data-sort-area",region.RegionId),map.setZoomAndCenter(zoomMin,region.LngLat)})),setTimeout((function(){anchorHotspot()}),1e3)),void toolbarZoomClick())}));var geocoder=new AMap.Geocoder({}),toolBar=new AMap.ToolBar({visible:!0});map.addControl(toolBar),toolBar.hideDirection(),toolBar.hideRuler(),toolBar.hideLocation();var toolbarZoomClick=function(){$(".amap-zoom-minus").on("click",(function(){var crrZoom;map.getZoom()<=10&&($("#map").attr("data-sort-area",""),console.log(map.getZoom()))}))},showHotspot=function(target){map.setZoomAndCenter(target[4],target[2]),setTimeout((function(){map.setZoomAndCenter(zoomMax,target[2])}),500)},districtMarkers=function(data,type){for(var i=0;i<data.length;i++)data[i].City.forEach((function(e){var markerTemp='<div class="custom-content-marker" data-area-cate="city" data-areaid="'+data[i].RegionId+'" data-cityid="'+e.CityId+'"><div class="amap-marker-label"><div class="info">'+e.CityName+'</div></div><a href="javascript:;" aria-label="'+e.CityName+'" onfocus="focusMarker(['+e.CityLngLat+'])"><i><svg xmlns="http://www.w3.org/2000/svg" width="35.469" height="53.56" viewBox="0 0 35.469 53.56"><defs><style>.cls-1 {fill: #F58025;fill-rule: evenodd;}</style></defs><path id="Shape_1_copy_12" data-name="Shape 1 copy 12" class="cls-1" d="M985.263,1060.73a17.808,17.808,0,0,0-17.722,17.85,18.007,18.007,0,0,0,2.128,8.49l14.625,26.64a1.109,1.109,0,0,0,1.938,0l14.628-26.65A17.87,17.87,0,0,0,985.263,1060.73Zm0,26.78a8.925,8.925,0,1,1,8.861-8.93A8.908,8.908,0,0,1,985.263,1087.51Z" transform="translate(-967.531 -1060.72)"/></svg></i></a></div>',marker=new AMap.Marker({position:e.CityLngLat,content:markerTemp,offset:new AMap.Pixel(0,0)});map.add(marker);var region=data[i].RegionId;marker.on("mouseover",(function(e){this.setTop(!0)})),marker.on("mouseout",(function(e){this.setTop(!1)})),marker.on("click",(function(){showHotspot([region,e.CityId,e.CityLngLat,map.getZoom()]),showHotspotList(e.CityId),paramUpdate.update("city",e.CityId,e.CityName)}))}))},hotspotMarkersTemp=function(data){return'<div class="custom-content-marker js-open-brief" data-hotspotid="'+data.HotspotId+'" data-cate="'+data.Category+'"><a href="javascript:openInfo(['+data.HotspotId+']);" aria-label="'+data.Title+'"><i><svg xmlns="http://www.w3.org/2000/svg" width="35.469" height="53.56" viewBox="0 0 35.469 53.56"><defs><style>.cls-1 {fill: #F58025;fill-rule: evenodd;}</style></defs><path id="Shape_1_copy_12" data-name="Shape 1 copy 12" class="cls-1" d="M985.263,1060.73a17.808,17.808,0,0,0-17.722,17.85,18.007,18.007,0,0,0,2.128,8.49l14.625,26.64a1.109,1.109,0,0,0,1.938,0l14.628-26.65A17.87,17.87,0,0,0,985.263,1060.73Zm0,26.78a8.925,8.925,0,1,1,8.861-8.93A8.908,8.908,0,0,1,985.263,1087.51Z" transform="translate(-967.531 -1060.72)"/><path id="Shape_1_copy_15" data-name="Shape 1 copy 15" class="cls-1" d="M985.266,1073.56a4.905,4.905,0,1,1-4.891,4.91A4.9,4.9,0,0,1,985.266,1073.56Zm0-12.83a17.808,17.808,0,0,0-17.722,17.85,18.007,18.007,0,0,0,2.128,8.49l14.625,26.64a1.109,1.109,0,0,0,1.938,0l14.628-26.65A17.87,17.87,0,0,0,985.263,1060.73Zm0,26.78a8.925,8.925,0,1,1,8.861-8.93A8.908,8.908,0,0,1,985.263,1087.51Z" transform="translate(-967.531 -1060.72)"/></svg></i></a></div>'},hotspotMarkers=function(){var data=MTR.articleDetail,allHotspot=[];$.each(data,(function(i,d){$.each(d.City,(function(e,x){$.each(x.Hotspot,(function(c,h){allHotspot.push(h)}))}))})),MTR.articleList=allHotspot;for(var hotspots=allHotspot,i=0;i<hotspots.length;i++){var spot=hotspots[i],markerContent=hotspotMarkersTemp(spot),marker=[];marker[i]=new AMap.Marker({position:spot.HotspotLngLat,title:spot.Title,content:markerContent}),marker[i].setMap(map)}};function openInfo(id){paramUpdate.update("hotspot",id);var windW=$(window).width(),wrap=$(".custom-content-marker[data-hotspotid="+id+"]").closest(".amap-marker");if(!wrap.hasClass("selected")){$(".amap-marker").removeClass("selected"),$(".amap-info").addClass("info-hidden");var infoWindow,data,like,hotspotlist=MTR.articleList;$.each(hotspotlist,(function(i,d){d.HotspotId==id&&(data=d)})),like=getIsLike(id),infoWindow=new AMap.InfoWindow({offset:new AMap.Pixel(3,-40),content:infoWindowTemp(data,like)});var crrZoom=map.getZoom();if(map.setZoomAndCenter(crrZoom,[data.HotspotLngLat[0],data.HotspotLngLat[1]]),wrap.addClass("selected"),windW>700)setTimeout((function(){infoWindow.open(map,data.HotspotLngLat),infoWindow.on("close",(function(){wrap.removeClass("selected")}))}),500),showHotspotListFocus(id);else for(var array=$("#hotspot-list").find(".hotspot-list-item"),i=0;i<array.length;i++){var el=array[i];$(el).data("hotspotid")==data.HotspotId&&slide.slideTo(i)}}}function infoWindowTemp(data,like){var wrap='<a href="javascript:openPopup(['+data.CityId+","+data.HotspotId+']);" data-cityid="'+data.CityId+'" data-hotspotid="'+data.HotspotId+'"><div class="info_content"><div class="info_img"><img src="'+data.DesktopPopupImage+'" onerror="MTR.imgError([this, \'hotspotsmall\']);"/></div><div class="info_title"><span>'+data.Title+'</span><div class="btn-like type-white';return like[0]&&(wrap+=" i-like"),wrap+='"data-article-section="hotspot" data-article-id="'+data.HotspotId+'" tabindex="-1"><span class="ico-heart"></span><span class="like-count">',like[1]>0?wrap+=like[1]:wrap+="0",wrap+="</span></div></div></div></a>"}function openPopup(target){MTR.popupHotspotOpeninMap(target)}function listSort(){$.each($(".hotspot-list-item"),(function(idx,tg){var _=$(this),cnt=_.find(".like-count").html();_.attr("data-like",cnt),_.bind("keyup",(function(e){13===event.keyCode&&(event.preventDefault(),openInfo(_.data("hotspotid")))}))}));var hotspotList=$("#hotspot-list .hotspot-list-wrap").find(".hotspot-list-item");hotspotList.sort((function(a,b){return $(b).data("like")-$(a).data("like")})),$("#hotspot-list .hotspot-list-wrap").append(hotspotList)}function clickLike(){$.each($(".btn-like"),(function(index,item){var id=$(this).data("article-id");$.each(MTR.articleLike,(function(d,list){"hotspot"==list.category&&$.each(list.detail,(function(c,like){if(like.CategoryId==id){var target=$('.btn-like[data-article-id="'+like.CategoryId+'"]');0==like.IsAbleToLike&&(target.addClass("i-like"),target.attr("tabindex","-1")),target.find(".like-count").html(like.TotalLike)}}))}))})),$(".btn-like").on("click",(function(){var _=$(this),section=_.data("article-section"),id=_.data("article-id");MTR.countlike([section,id]),clickLike(),$.getJSON(LIKE_API_ALL).then(function(data){MTR.articleLike=data}.bind(this))}))}function getIsLike(data){var id=data,info=!1,likeCount,cnt=0;return $.each(MTR.articleLike,(function(d,list){list.category==MTR.pageid&&$.each(list.detail,(function(c,like){like.CategoryId==id&&(0==like.IsAbleToLike&&cnt++,likeCount=like.TotalLike)}))})),cnt>0?[!0,likeCount]:[!1,likeCount]}function genHotspotList(city){var data=MTR.articleDetail,listWrap=$("#hotspot-list .hotspot-list-wrap"),cityHotspot=[],finish=!1;function listTemp(data){return'<div onClick="openInfo(['+data.HotspotId+'])" tabindex="1" class="hotspot-list-item swiper-slide" data-cityid="'+data.CityId+'" data-hotspotid="'+data.HotspotId+'"><button class="hotspot-list-open_m" onClick="openPopup(['+data.CityId+","+data.HotspotId+']);"></button><div class="hotspot-list-item-in"><div aria-label="true" class="list-thumb"><figure><img src="'+data.DesktopPopupImage+'" alt="" class="br767" onerror="MTR.imgError([this, \'hotspotlist\']);"/><img src="'+data.MobilePopupImage+'" alt="" class="view767" onerror="MTR.imgError([this,\'hotspotlist\']);"/><figcaption class="blind">'+data.Title+'</figcaption></figure></div><div class="list-detail"><div class="list-detail-in"><div class="list-detail_type" data-cate="'+data.Category+'"><i><svg xmlns="http://www.w3.org/2000/svg" width="13.56" height="20.375" viewBox="0 0 13.56 20.375"><defs><style>.cls-1 {fill: #F58025;fill-rule: evenodd;}</style></defs><path id="Shape_1_copy_16" data-name="Shape 1 copy 16" class="cls-1" d="M1734.06,746.514a6.781,6.781,0,0,0-5.97,10.014l5.6,10.131a0.409,0.409,0,0,0,.37.219,0.432,0.432,0,0,0,.37-0.219l5.6-10.135A6.778,6.778,0,0,0,1734.06,746.514Zm0,10.182a3.394,3.394,0,1,1,3.39-3.394A3.4,3.4,0,0,1,1734.06,756.7Z" transform="translate(-1727.28 -746.5)"/></svg></i><div class="list-detail_type__name">'+MTR.articleCate[data.Category-1]+'</div></div><div class="list-detail_name">'+data.Title+'</div><div class="btn-like" class="" data-article-section="hotspot" data-article-id="'+data.HotspotId+'" tabindex="0"><span class="ico-heart"></span><span class="like-count">0</span></div></div></div></div></div>'}$.each(data,(function(i,d){$.each(d.City,(function(e,x){x.CityId==city&&($("#panel").attr("data-city",x.CityCode),hotspotCity=x.CityCode,$(".city_label").html(x.CityName),$(".city_desc").html(x.CityDescription),$.each(x.Hotspot,(function(c,h){cityHotspot.push(h)})))}))})),setPanelH(),listWrap.html("");for(let i=0;i<cityHotspot.length;i++){var el=cityHotspot[i];if(listWrap.append(listTemp(el)),i+1==cityHotspot.length)return!0}}function setPanelH(){var checkHeight={init:function(){checkHeight.setH(),checkHeight.resizeH()},setH:function(){var maxH=$("#map").height();$("#panel").css("height",maxH),$("#hotspot-list").css("height",maxH-$(".city_desc_container").outerHeight())},resizeH:function(){$(window).resize((function(){checkHeight.setH(),setTimeout((function(){checkHeight.setH()}),1e3)}))}};checkHeight.init()}function showHotspotList(city){var deploy,windW;genHotspotList(city)&&($("#hotspot-list").animate({scrollTop:$("#hotspot-list").prop("scrollHeight")-$("#hotspot-list").prop("scrollHeight")},600),clickLike(),listSort(),setCitydescH.destroy(),null!=slide&&(slide.destroy(),slide=void 0),setCitydescH.init(),$(window).width()<1e3&&setCitydescH.set(),listSlide())}function checkHasHotspot(){var data=MTR.articleDetail,status=!1,newCity,newCityId;map.getCity((function(info){var nowCity;($.each(data,(function(i,d){$.each(d.City,(function(e,x){x.CityCode==info.citycode&&""!=info.citycode&&x.Hotspot.length>0&&(status=!0,newCity=x.CityCode,newCityId=x.CityId)}))})),status)&&(hotspotCity!=newCity&&showHotspotList(newCityId))}));var center=map.getCenter()}function checkRegion(){var data=MTR.articleDetail,status=!1,newRegion,newCity;map.getCity((function(info){if($.each(data,(function(i,d){$.each(d.City,(function(e,x){x.CityCode==info.citycode&&""!=info.citycode&&x.Hotspot.length>0&&(status=!0,newRegion=d.RegionId,newCity=x.CityId)}))})),status){var zoom=map.getZoom();zoom<=turn?paramUpdate.update("region",newRegion):zoom>turn&&paramUpdate.update("city",newCity)}}));var center=map.getCenter()}function showHotspotListFocus(id){var windW=$(window).width(),listDiv=$("#hotspot-list"),listInnerH=listDiv.prop("scrollHeight"),listItemH=$("#hotspot-list .hotspot-list-item:nth-child(2)").height(),total=$("#hotspot-list .hotspot-list-item"),order;total.removeClass("selected");for(let i=1;i<total.length+1;i++){var listedHotspot;$(".hotspot-list-item:nth-child("+i+")").data("hotspotid")==id&&($(".hotspot-list-item:nth-child("+i+")").addClass("selected"),order=i-1)}var listItemTop=listItemH*order;windW>700&&listDiv.animate({scrollTop:listItemTop},600)}var paramUpdate={check:function(para){var url;return window.location.href.indexOf(para)>-1},checkPrev:function(type,query){for(var query,vars=window.location.search.substring(1).split("&"),i=0;i<vars.length;i++){var pair;if(vars[i].split("=")[0]==type)return vars[i]}},newurl:function(type,value){var url=window.location.href,prev_r=paramUpdate.checkPrev("region"),prev_c=paramUpdate.checkPrev("city"),prev_h=paramUpdate.checkPrev("hotspot"),prev_d=paramUpdate.checkPrev("detail"),new_r,new_h,new_c,new_d,newurl;if("region"==type){var newurl=url;return newParam=type+"="+value,newurl=newurl.replace(prev_r,newParam),void 0===prev_r?url.indexOf("?")?(newurl=url.split("?")[0]+"?"+type+"="+value,url.split("?")[1]&&(newurl+="&"+url.split("?")[1])):newurl=newurl+"?"+type+"="+value:newurl=newurl.replace(prev_r,type+"="+value),prev_c&&(newurl=newurl.replace("&"+prev_c,"")),prev_h&&(newurl=newurl.replace("&"+prev_h,"")),newurl}if("city"==type){if($.each(MTR.articleDetail,(function(i,region){$.each(region.City,(function(d,city){if(city.CityId==value)return new_r=region.RegionId,void(new_c=city.CityId)}))})),null!=new_c){var params=[{param:"region",old:prev_r,new:new_r},{param:"city",old:prev_c,new:new_c},{param:"hotspot",old:prev_h,new:new_h},{param:"detail",old:prev_d,new:new_d}];for(let i=0;i<params.length;i++){if(0==i)var newurl=url;const el=params[i];null!=el.new&&(newParam=el.param+"="+el.new,newurl=newurl.replace(el.old,newParam))}return null==prev_r&&(newurl=newurl+"?region="+new_r),null==prev_c&&(newurl=newurl+"&"+type+"="+new_c),prev_r&&(newurl=newurl.replace(prev_r,"region="+new_r)),null==new_h&&(prev_d?newurl=newurl.replace("&"+prev_d,""):null!=prev_h&&(newurl=newurl+"&"+prev_h)),prev_h&&(newurl=newurl.replace("&"+prev_h,"")),prev_c!="city="+new_c&&(newurl=newurl.replace("&"+prev_h,"")),newurl}return url}if("hotspot"==type){if($.each(MTR.articleDetail,(function(i,region){$.each(region.City,(function(d,city){$.each(city.Hotspot,(function(c,spot){if(spot.HotspotId==value)return new_r=region.RegionId,new_c=city.CityId,void(new_h=spot.HotspotId)}))}))})),null!=new_h){var params=[{param:"region",old:prev_r,new:new_r},{param:"city",old:prev_c,new:new_c},{param:"hotspot",old:prev_h,new:new_h}];for(let i=0;i<params.length;i++){if(0==i)var newurl=url;const el=params[i];newParam=el.param+"="+el.new,newurl=newurl.replace(el.old,newParam)}return null==prev_r&&(newurl=newurl+"&region="+new_r),null==prev_c&&(newurl=newurl+"&city="+new_c),null==prev_h&&(newurl=newurl+"&"+type+"="+new_h),newurl}return url}if("detail"==type)return(newurl=url)+"&detail=1"},update:function(type,value,title){window.history.pushState(title,"",paramUpdate.newurl(type,value))},remove:function(type,title){var url=window.location.href,prev_r=paramUpdate.checkPrev("region"),prev_c=paramUpdate.checkPrev("city"),prev_h=paramUpdate.checkPrev("hotspot"),prev_d=paramUpdate.checkPrev("detail");if("city"==type){var newurl=url;prev_c&&(newurl=newurl.replace("&"+prev_c,"")),prev_h&&(newurl=newurl.replace("&"+prev_h,"")),window.history.pushState("","",newurl)}if("hotspot"==type){var newurl=url;prev_h&&(newurl=newurl.replace("&"+prev_h,"")),window.history.pushState("","",newurl)}if("detail"==type){var newurl=url;prev_d&&(newurl=newurl.replace("&"+prev_d,"")),window.history.pushState("","",newurl)}}};function listSlide(){function initSlider(){var screenWidth=$(window).width();screenWidth<1e3&&null==slide?(slide=new Swiper("#hotspot-list",{breakpoints:{300:{slidesPerView:1.3,spaceBetween:10,centeredSlides:!0},768:{slidesPerView:2,spaceBetween:10,centeredSlides:!0},1024:{slidesPerView:3,spaceBetween:10}},on:{init:function(){}}})).on("transitionStart",(function(){var array=$("#hotspot-list").find(".hotspot-list-item"),target=$(".swiper-slide-active").data("hotspotid");array.removeClass("selected");for(var i=0;i<array.length;i++){var el=array[i];$(el).data("hotspotid")==target&&(openInfo([$(el).data("hotspotid")]),$(el).addClass("selected"))}})):screenWidth>1e3&&null!=slide&&(slide.destroy(),slide=void 0,$("#hotspot-list .swiper-wrapper").removeAttr("style"),$("#hotspot-list .swiper-slide").removeAttr("style"))}slide=void 0,initSlider(),$(window).on("resize",(function(){initSlider()}))}var setCitydescH={init:function(){var windW;$(window).width()<1e3?setCitydescH.set():setCitydescH.destroy(),setCitydescH.resize()},click:function(){var descwrap=$(".city_desc_container"),inner=$(".city_desc_in"),desc=$(".city_desc"),descH=desc.height(),lineH=$(".city_label").outerHeight(),btnmore;$(".city_desc_more").on("click",(function(){if(descwrap.hasClass("toggle-on"))return descwrap.removeClass("toggle-on"),void inner.animate({maxHeight:24},300,"linear",(function(){desc.addClass("off")}));descwrap.addClass("toggle-on"),desc.removeClass("off"),inner.animate({maxHeight:300},300,"linear")}))},set:function(){var descwrap=$(".city_desc_container"),inner=$(".city_desc_in"),desc=$(".city_desc"),descH=desc.height(),lineH=$(".city_label").outerHeight();desc.removeClass("off"),descH>lineH+15&&(descwrap.addClass("desc-toggle toggle-ready"),desc.addClass("off"),inner.css({maxHeight:lineH,overflow:"hidden"}))},resize:function(){var descwrap=$(".city_desc_container");$(window).resize((function(){var windW;$(window).width()<1e3?setCitydescH.set():setCitydescH.destroy()}))},destroy:function(){var descwrap=$(".city_desc_container"),inner=$(".city_desc_in"),desc=$(".city_desc");descwrap.removeClass("desc-toggle toggle-on"),descwrap.attr("style",""),inner.attr("style",""),desc.attr("style","")}};setCitydescH.click();var dataUpdate={init:function(){dataUpdate.zoomInOut(),dataUpdate.drag()},zoomInOut:function(){map.on("zoomend",(function(){var zoom=map.getZoom();zoom<=turn?(dataUpdate.setMode("district"),paramUpdate.remove("city")):zoom>turn&&dataUpdate.setMode("city")})),checkHasHotspot()},drag:function(){map.on("moveend",(function(){checkRegion(),checkHasHotspot()}))},setMode:function(type,target){var mode=type,cmode=sessionStorage.getItem("MODE"),changeItem=[$(".amap_marker_guide")];if(mode!=cmode){if(map.clearMap(),"district"==mode){districtMarkers(MTR.articleDetail,mode);for(let i=0;i<changeItem.length;i++){var target;(target=changeItem[i]).removeClass("on")}mapwrap.attr("data-mode",mode)}if("city"==mode){hotspotMarkers(),setCitydescH.init();for(let i=0;i<changeItem.length;i++){var target;(target=changeItem[i]).addClass("on")}mapwrap.attr("data-mode",mode)}}sessionStorage.setItem("MODE",mode)}};dataUpdate.init(),$(".panel_toggle").on("click",(function(){mapwrap.attr("data-panel",(function(index,attr){return"on"==attr?"off":"on"}))})),MTR.articleCate=["購物","飲食","玩樂","觀光","文藝"];var focusMarker=function(LngLat){$("body").hasClass("a11y-on")&&map.setZoomAndCenter(7,LngLat)};